<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Visual Code Review - SDE2 PrepOps</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            line-height: 1.5;
        }

        .header {
            background: linear-gradient(135deg, #161b22 0%, #1c2128 100%);
            padding: 20px;
            border-bottom: 1px solid #30363d;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo h1 {
            font-size: 24px;
            font-weight: 700;
            color: #f0f6fc;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .status-bar {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stats {
            background: #0d1117;
            padding: 16px;
            border: 1px solid #30363d;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .stats h3 {
            color: #f0f6fc;
            margin-bottom: 12px;
            font-size: 18px;
        }

        .stats pre {
            background: #161b22;
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 13px;
            color: #7d8590;
        }

        .file-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 20px 0;
        }

        .file-item {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.2s ease;
            position: relative;
        }

        .file-item:hover {
            border-color: #58a6ff;
            box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.1);
        }

        .file-header {
            padding: 16px;
            font-weight: 600;
            color: #f0f6fc;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .file-header:hover {
            background: #21262d;
        }

        .file-path {
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
        }

        .file-diff {
            display: none;
            background: #0d1117;
            border-top: 1px solid #30363d;
            max-height: 600px;
            overflow-y: auto;
        }

        .file-diff.active {
            display: block;
            animation: slideDown 0.2s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .diff-line {
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            font-size: 13px;
            padding: 2px 16px;
            border-left: 4px solid transparent;
            white-space: pre;
            overflow-x: auto;
        }

        .diff-added {
            background: rgba(46, 160, 67, 0.15);
            border-left-color: #2ea043;
            color: #aff5b4;
        }

        .diff-removed {
            background: rgba(248, 81, 73, 0.15);
            border-left-color: #f85149;
            color: #ffdcd7;
        }

        .diff-context {
            color: #8b949e;
            background: rgba(255, 255, 255, 0.02);
        }

        .diff-header {
            background: #161b22;
            color: #7d8590;
            padding: 8px 16px;
            font-weight: 600;
            border-bottom: 1px solid #30363d;
        }

        .export-btn {
            background: linear-gradient(135deg, #2ea043, #238636);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .export-btn:hover {
            background: linear-gradient(135deg, #238636, #2ea043);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(46, 160, 67, 0.3);
        }

        .export-btn:active {
            transform: translateY(0);
        }

        .badge {
            background: #1f6feb;
            color: white;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .badge.modified {
            background: #ff8c00;
        }

        .badge.added {
            background: #2ea043;
        }

        .badge.deleted {
            background: #f85149;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7d8590;
        }

        .empty-state .icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .empty-state h3 {
            color: #f0f6fc;
            font-size: 20px;
            margin-bottom: 8px;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            gap: 12px;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #30363d;
            border-top: 2px solid #58a6ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-message {
            background: rgba(46, 160, 67, 0.15);
            border: 1px solid #2ea043;
            border-radius: 8px;
            padding: 16px;
            margin: 20px 0;
            color: #aff5b4;
        }

        .error-message {
            background: rgba(248, 81, 73, 0.15);
            border: 1px solid #f85149;
            border-radius: 8px;
            padding: 16px;
            margin: 20px 0;
            color: #ffdcd7;
        }

        .file-stats {
            font-size: 12px;
            color: #7d8590;
            display: flex;
            gap: 16px;
        }

        .expand-icon {
            transition: transform 0.2s ease;
        }

        .expand-icon.rotated {
            transform: rotate(90deg);
        }

        .comment-btn {
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 6px 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #7d8590;
            font-size: 14px;
        }

        .comment-btn:hover {
            background: #30363d;
            border-color: #58a6ff;
            color: #58a6ff;
        }

        .comment-btn.has-comment {
            background: #1f6feb;
            color: white;
            border-color: #1f6feb;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal h3 {
            color: #f0f6fc;
            font-size: 18px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .comment-textarea {
            width: 100%;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 12px;
            color: #c9d1d9;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.5;
            resize: vertical;
            min-height: 120px;
        }

        .comment-textarea:focus {
            outline: none;
            border-color: #58a6ff;
            box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.1);
        }

        .comment-templates {
            margin-bottom: 16px;
        }

        .comment-templates h4 {
            color: #7d8590;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .template-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .template-btn {
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
            color: #7d8590;
            transition: all 0.2s ease;
        }

        .template-btn:hover {
            background: #30363d;
            color: #58a6ff;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s ease;
            border: none;
        }

        .modal-btn.primary {
            background: #238636;
            color: white;
        }

        .modal-btn.primary:hover {
            background: #2ea043;
        }

        .modal-btn.secondary {
            background: #30363d;
            color: #7d8590;
        }

        .modal-btn.secondary:hover {
            background: #21262d;
            color: #c9d1d9;
        }

        .comment-display {
            background: rgba(88, 166, 255, 0.1);
            border: 1px solid #58a6ff;
            border-radius: 6px;
            padding: 8px 12px;
            margin-top: 8px;
            font-size: 12px;
            color: #c9d1d9;
            white-space: pre-wrap;
        }

        /* GitHub-style line-by-line diff */
        .diff-line-container {
            display: flex;
            align-items: stretch;
            border-bottom: 1px solid #21262d;
            position: relative;
        }

        .diff-line-container:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .diff-line-container:hover .add-comment-btn {
            opacity: 1;
        }

        .line-numbers {
            display: flex;
            align-items: center;
            background: #161b22;
            padding: 4px 8px;
            border-right: 1px solid #30363d;
            min-width: 120px;
            position: relative;
        }

        .old-line-num, .new-line-num {
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            color: #656d76;
            width: 35px;
            text-align: right;
            user-select: none;
        }

        .add-comment-btn {
            background: transparent;
            border: none;
            color: #656d76;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s ease;
            padding: 2px;
            margin-left: 4px;
            font-size: 12px;
        }

        .add-comment-btn:hover {
            color: #58a6ff;
            background: rgba(88, 166, 255, 0.1);
            border-radius: 3px;
        }

        .line-content {
            flex: 1;
            padding: 4px 8px;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            overflow-x: auto;
        }

        .line-content code {
            background: none;
            color: inherit;
            padding: 0;
            white-space: pre;
        }

        .diff-line-container.diff-added {
            background: rgba(46, 160, 67, 0.15);
        }

        .diff-line-container.diff-removed {
            background: rgba(248, 81, 73, 0.15);
        }

        .diff-line-container.diff-context {
            background: transparent;
        }

        .diff-line-container.diff-added .line-numbers {
            background: rgba(46, 160, 67, 0.2);
            border-left: 3px solid #2ea043;
        }

        .diff-line-container.diff-removed .line-numbers {
            background: rgba(248, 81, 73, 0.2);
            border-left: 3px solid #f85149;
        }

        .line-comment {
            background: #fff8c5;
            border: 1px solid #d1cc5d;
            border-radius: 6px;
            padding: 8px 12px;
            margin: 4px 8px 8px 128px;
            color: #1f2328;
            font-size: 12px;
            position: relative;
        }

        .line-comment::before {
            content: '';
            position: absolute;
            top: -8px;
            left: 16px;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid #d1cc5d;
        }

        .line-comment.line-comment-visible {
            display: block;
            animation: slideInComment 0.3s ease-out;
        }

        @keyframes slideInComment {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .has-line-comment {
            background: rgba(255, 212, 59, 0.1) !important;
            border-left: 3px solid #ffd43b !important;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <span style="font-size: 28px;">üîç</span>
                <h1>AI Visual Code Review</h1>
                <span id="projectName" style="color: #58a6ff; font-size: 14px; font-weight: 500;">Loading...</span>
            </div>
            <div style="display: flex; gap: 12px;">
                <button class="export-btn" onclick="exportForAI()" id="exportBtn">
                    <span>üì§</span>
                    Export for AI Review
                </button>
                <button class="export-btn" style="background: linear-gradient(135deg, #1f6feb, #58a6ff);" onclick="exportIndividualReviews()" id="exportIndividualBtn">
                    <span>üìÅ</span>
                    Export Individual Files
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="status-bar">
            <div>
                <strong style="color: #f0f6fc;">Repository Status</strong>
                <span id="statusText" style="color: #7d8590; margin-left: 12px;">Checking...</span>
            </div>
            <div style="font-size: 12px; color: #7d8590;" id="timestamp">
                Loading...
            </div>
        </div>

        <div class="stats" id="stats">
            <div class="loading">
                <div class="spinner"></div>
                <span>Loading change summary...</span>
            </div>
        </div>

        <div class="file-list" id="fileList">
            <div class="loading">
                <div class="spinner"></div>
                <span>Loading staged files...</span>
            </div>
        </div>
    </div>

    <!-- Comment Modal -->
    <div class="modal-overlay" id="commentModal" onclick="closeCommentModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <h3>
                <span>üí≠</span>
                Add Comment
                <span id="modalFileName" style="color: #7d8590; font-size: 14px; font-weight: normal;"></span>
            </h3>

            <div class="comment-templates">
                <h4>üí° Quick Templates:</h4>
                <div class="template-buttons">
                    <button class="template-btn" onclick="insertTemplate('üêõ Bug: ')">üêõ Bug</button>
                    <button class="template-btn" onclick="insertTemplate('‚ö†Ô∏è Warning: ')">‚ö†Ô∏è Warning</button>
                    <button class="template-btn" onclick="insertTemplate('üí° Suggestion: ')">üí° Suggestion</button>
                    <button class="template-btn" onclick="insertTemplate('‚ùì Question: ')">‚ùì Question</button>
                    <button class="template-btn" onclick="insertTemplate('üîç Review: ')">üîç Review</button>
                    <button class="template-btn" onclick="insertTemplate('‚úÖ Approve: ')">‚úÖ Approve</button>
                    <button class="template-btn" onclick="insertTemplate('üöÄ Performance: ')">üöÄ Performance</button>
                    <button class="template-btn" onclick="insertTemplate('üîí Security: ')">üîí Security</button>
                </div>
            </div>

            <textarea
                id="commentTextarea"
                class="comment-textarea"
                placeholder="Add your review comments, questions, or suggestions for this file..."
            ></textarea>

            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeCommentModal()">Cancel</button>
                <button class="modal-btn primary" onclick="saveComment()">üíæ Save Comment</button>
            </div>
        </div>
    </div>

    <script>
        // Global state variables (missing declarations causing export button issues)
        let allDiffs = {};
        let allParsedDiffs = {};
        let fileComments = {};
        let lineComments = {};
        let selectedFiles = new Set();
        let currentCommentFile = '';
        let currentCommentFileId = '';
        let currentLineId = '';
        let currentLineNumber = 0;

        // Enhanced memory management
        class MemoryManager {
            constructor() {
                this.maxCacheSize = 50;
                this.cleanupInterval = 300000; // 5 minutes
                this.startCleanupTimer();
            }

            startCleanupTimer() {
                setInterval(() => {
                    this.cleanup();
                }, this.cleanupInterval);
            }

            cleanup() {
                console.log('üßπ Running memory cleanup...');

                // Clean diff cache if too large
                if (Object.keys(allDiffs).length > this.maxCacheSize) {
                    const keys = Object.keys(allDiffs);
                    const keysToRemove = keys.slice(0, keys.length - this.maxCacheSize);
                    keysToRemove.forEach(key => {
                        delete allDiffs[key];
                        delete allParsedDiffs[key];
                    });
                    console.log(`üóëÔ∏è Cleaned ${keysToRemove.length} cached diffs`);
                }

                // Clean up DOM nodes that might be detached
                this.cleanupDetachedNodes();
            }

            cleanupDetachedNodes() {
                // Remove any orphaned event listeners or references
                const commentDivs = document.querySelectorAll('.line-comment');
                commentDivs.forEach(div => {
                    if (!div.parentNode) {
                        // This is an orphaned node, clean it up
                        div.remove();
                    }
                });
            }
        }

        // Enhanced state management with memory limits
        const state = {
            allDiffs: new Map(),
            allParsedDiffs: new Map(),
            fileComments: new Map(),
            lineComments: new Map(),
            selectedFiles: new Set(),
            currentCommentFile: '',
            currentCommentFileId: '',
            currentLineId: '',
            currentLineNumber: 0,
            loadingStates: new Map(),

            // Memory management methods
            addDiff(file, diff, parsedDiff) {
                this.allDiffs.set(file, diff);
                this.allParsedDiffs.set(file, parsedDiff);

                // Limit cache size
                if (this.allDiffs.size > 50) {
                    const firstKey = this.allDiffs.keys().next().value;
                    this.allDiffs.delete(firstKey);
                    this.allParsedDiffs.delete(firstKey);
                }
            },

            clear() {
                this.allDiffs.clear();
                this.allParsedDiffs.clear();
                this.loadingStates.clear();
            }
        };

        // Initialize memory manager
        const memoryManager = new MemoryManager();

        // Enhanced loading states
        const LoadingStates = {
            show(element, message = 'Loading...') {
                if (!element) return;
                element.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <span>${message}</span>
                    </div>
                `;
            },

            hide(element) {
                if (!element) return;
                const loading = element.querySelector('.loading');
                if (loading) loading.remove();
            },

            error(element, message) {
                if (!element) return;
                element.innerHTML = `
                    <div class="error-message">
                        <span>‚ùå</span>
                        <span>${message}</span>
                        <button onclick="location.reload()" style="margin-left: 10px; padding: 4px 8px; background: #f85149; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            üîÑ Retry
                        </button>
                    </div>
                `;
            }
        };

        // Enhanced notification system
        const NotificationSystem = {
            show(message, type = 'info', duration = 5000) {
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 12px 16px;
                    border-radius: 8px;
                    color: white;
                    font-weight: 500;
                    z-index: 10000;
                    max-width: 400px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    animation: slideIn 0.3s ease-out;
                    cursor: pointer;
                `;

                const colors = {
                    info: '#1f6feb',
                    success: '#2ea043',
                    warning: '#fb8500',
                    error: '#f85149'
                };

                notification.style.backgroundColor = colors[type] || colors.info;
                notification.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span>${this.getIcon(type)}</span>
                        <span>${message}</span>
                        <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: white; cursor: pointer; font-size: 16px; margin-left: auto;">√ó</button>
                    </div>
                `;

                document.body.appendChild(notification);

                if (duration > 0) {
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, duration);
                }

                notification.onclick = () => notification.remove();
            },

            getIcon(type) {
                const icons = {
                    info: '‚ÑπÔ∏è',
                    success: '‚úÖ',
                    warning: '‚ö†Ô∏è',
                    error: '‚ùå'
                };
                return icons[type] || icons.info;
            }
        };

        // Add CSS for notifications
        const notificationStyles = document.createElement('style');
        notificationStyles.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }

            .notification {
                animation: slideIn 0.3s ease-out;
            }

            .notification:hover {
                transform: scale(1.02);
                transition: transform 0.2s ease;
            }
        `;
        document.head.appendChild(notificationStyles);

        // Enhanced initialization with error handling
        async function init() {
            try {
                NotificationSystem.show('üîç Initializing AI Visual Code Review...', 'info', 3000);

                await Promise.all([
                    loadHealthCheck().catch(err => console.warn('Health check failed:', err)),
                    loadSummary().catch(err => console.warn('Summary load failed:', err)),
                    loadFiles().catch(err => console.warn('Files load failed:', err))
                ]);

                NotificationSystem.show('‚úÖ Ready for code review!', 'success', 3000);
            } catch (error) {
                console.error('Initialization failed:', error);
                NotificationSystem.show('‚ùå Failed to initialize. Please refresh the page.', 'error', 0);
            }
        }

        // Comment functionality
        function showCommentModal(file, fileId) {
            currentCommentFile = file;
            currentCommentFileId = fileId;

            const modal = document.getElementById('commentModal');
            const fileNameSpan = document.getElementById('modalFileName');
            const textarea = document.getElementById('commentTextarea');

            fileNameSpan.textContent = `for ${file}`;
            textarea.value = fileComments[file] || '';
            textarea.focus();

            modal.classList.add('active');
        }

        function closeCommentModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('commentModal').classList.remove('active');
        }

        function insertTemplate(template) {
            const textarea = document.getElementById('commentTextarea');
            const currentText = textarea.value;
            const cursorPos = textarea.selectionStart;

            const newText = currentText.slice(0, cursorPos) + template + currentText.slice(cursorPos);
            textarea.value = newText;
            textarea.focus();
            textarea.setSelectionRange(cursorPos + template.length, cursorPos + template.length);
        }

        function saveComment() {
            const textarea = document.getElementById('commentTextarea');
            const comment = textarea.value.trim();

            if (comment) {
                fileComments[currentCommentFile] = comment;

                // Update comment button to show it has a comment
                const commentBtn = document.querySelector(`[onclick*="'${currentCommentFile}'"]`);
                if (commentBtn) {
                    commentBtn.classList.add('has-comment');
                    const indicator = document.getElementById(`comment-indicator-${currentCommentFileId}`);
                    if (indicator) {
                        indicator.style.display = 'inline';
                    }
                }

                // Add comment display to the file
                showCommentInFile(currentCommentFile, currentCommentFileId, comment);
            } else {
                // Remove comment if empty
                delete fileComments[currentCommentFile];
                const commentBtn = document.querySelector(`[onclick*="'${currentCommentFile}'"]`);
                if (commentBtn) {
                    commentBtn.classList.remove('has-comment');
                    const indicator = document.getElementById(`comment-indicator-${currentCommentFileId}`);
                    if (indicator) {
                        indicator.style.display = 'none';
                    }
                }
                removeCommentFromFile(currentCommentFileId);
            }

            closeCommentModal();
        }

        function showCommentInFile(file, fileId, comment) {
            // Remove existing comment display
            removeCommentFromFile(fileId);

            // Add comment display after file header
            const fileItem = document.getElementById(`diff-${fileId}`).parentElement;
            const commentDiv = document.createElement('div');
            commentDiv.id = `comment-display-${fileId}`;
            commentDiv.className = 'comment-display';
            commentDiv.innerHTML = `<strong>üí≠ Your Comment:</strong><br>${escapeHtml(comment)}`;

            const fileHeader = fileItem.querySelector('.file-header');
            fileHeader.parentNode.insertBefore(commentDiv, fileHeader.nextSibling);
        }

        function removeCommentFromFile(fileId) {
            const existingComment = document.getElementById(`comment-display-${fileId}`);
            if (existingComment) {
                existingComment.remove();
            }
        }

        // Enhanced health check with error recovery
        async function loadHealthCheck() {
            const statusText = document.getElementById('statusText');
            const timestamp = document.getElementById('timestamp');
            const projectNameElement = document.getElementById('projectName');

            try {
                const response = await fetch('/api/health');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                // Update project name with actual directory
                if (data.cwd) {
                    const projectName = data.cwd.split('/').pop() || 'Project';
                    projectNameElement.textContent = projectName;
                    document.title = `üîç AI Visual Code Review - ${projectName}`;
                }

                // Enhanced status messages with actionable advice
                if (data.totalChanges === 0) {
                    statusText.innerHTML = 'üìù No changes detected - make some changes to get started';
                    statusText.style.color = '#7d8590';
                } else if (data.stagedCount > 0 && data.unstagedCount > 0) {
                    statusText.innerHTML = `‚úÖ ${data.stagedCount} staged + ${data.unstagedCount} unstaged changes ready`;
                    statusText.style.color = '#58a6ff';
                } else if (data.stagedCount > 0) {
                    statusText.innerHTML = `‚úÖ ${data.stagedCount} staged changes ready for review`;
                    statusText.style.color = '#aff5b4';
                } else if (data.unstagedCount > 0) {
                    statusText.innerHTML = `‚ö†Ô∏è ${data.unstagedCount} unstaged changes - run "git add ." to stage them`;
                    statusText.style.color = '#ffd43b';
                } else {
                    statusText.innerHTML = 'üìù Repository is clean';
                    statusText.style.color = '#7d8590';
                }

                timestamp.textContent = `Last updated: ${new Date(data.timestamp).toLocaleTimeString()} | Version: ${data.version || '1.0.0'}`;
            } catch (error) {
                console.error('Health check failed:', error);
                statusText.innerHTML = '‚ùå Status check failed - <button onclick="loadHealthCheck()" style="background: none; border: none; color: #58a6ff; cursor: pointer; text-decoration: underline;">Retry</button>';
                statusText.style.color = '#f85149';
                timestamp.textContent = 'Connection error';

                NotificationSystem.show('Health check failed. Please check if the server is running.', 'error', 8000);
            }
        }

        // Enhanced summary loading with better error handling
        async function loadSummary() {
            const statsElement = document.getElementById('stats');

            try {
                LoadingStates.show(statsElement, 'Loading change summary...');

                const response = await fetch('/api/summary');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                if (data.stats && data.stats.trim()) {
                    statsElement.innerHTML = `
                        <h3>üìä Change Summary <span style="font-size: 12px; color: #7d8590; font-weight: normal;">(Generated: ${data.generated ? new Date(data.generated).toLocaleTimeString() : 'now'})</span></h3>
                        <pre>${data.stats}</pre>
                    `;
                } else {
                    statsElement.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">üìÑ</div>
                            <h3>No Changes</h3>
                            <p>Stage some changes with <code>git add .</code> to see statistics</p>
                            <button onclick="loadSummary()" style="margin-top: 12px; padding: 8px 16px; background: #238636; color: white; border: none; border-radius: 6px; cursor: pointer;">üîÑ Refresh</button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Summary load failed:', error);
                LoadingStates.error(statsElement, `Failed to load summary: ${error.message}`);
            }
        }

        // Enhanced file loading with progressive loading and better UX
        async function loadFiles() {
            const container = document.getElementById('fileList');

            try {
                LoadingStates.show(container, 'Loading staged files...');

                const response = await fetch('/api/staged-files');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                if (!data.files || data.files.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">üìÅ</div>
                            <h3>No Staged Changes</h3>
                            <p>Stage your changes with <code>git add .</code> to start reviewing</p>
                            <p style="margin-top: 12px; font-size: 14px;">
                                Or run <code>git add [specific-files]</code> to stage individual files
                            </p>
                            <div style="margin-top: 16px;">
                                <button onclick="location.reload()" style="padding: 8px 16px; background: #238636; color: white; border: none; border-radius: 6px; cursor: pointer; margin-right: 8px;">üîÑ Refresh</button>
                                <button onclick="window.open('https://git-scm.com/docs/git-add', '_blank')" style="padding: 8px 16px; background: #1f6feb; color: white; border: none; border-radius: 6px; cursor: pointer;">üìö Learn Git Add</button>
                            </div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = '';

                // Enhanced file processing with better icons and metadata
                data.files.forEach((file, index) => {
                    const fileId = file.replace(/[^a-zA-Z0-9]/g, '_');
                    const fileExt = file.substring(file.lastIndexOf('.')).toLowerCase();
                    const fileName = file.substring(file.lastIndexOf('/') + 1);
                    const filePath = file.substring(0, file.lastIndexOf('/')) || '.';

                    // Determine file status from API response
                    const fileStatus = data.fileStatuses && data.fileStatuses[file];
                    let badgeClass = 'modified';
                    let badgeText = 'Modified';
                    let fileIcon = 'üìÑ';
                    let fileTypeDesc = 'File';

                    // Parse git status using simplified GitStatusParser logic
                    const statusInfo = parseGitStatus(fileStatus || 'M');
                    badgeClass = statusInfo.badgeClass;
                    badgeText = statusInfo.badgeText;
                    fileIcon = statusInfo.icon;

                    // Enhanced file type detection (override icon only if not deleted)
                    if (fileStatus !== 'D') {
                        const fileTypeMap = {
                            '.tsx': { icon: '‚öõÔ∏è', desc: 'TypeScript React' },
                            '.ts': { icon: 'üìò', desc: 'TypeScript' },
                            '.js': { icon: 'üü®', desc: 'JavaScript' },
                            '.jsx': { icon: '‚öõÔ∏è', desc: 'React Component' },
                            '.json': { icon: 'üìã', desc: 'JSON Config' },
                            '.md': { icon: 'üìñ', desc: 'Markdown' },
                            '.css': { icon: 'üé®', desc: 'Stylesheet' },
                            '.scss': { icon: 'üé®', desc: 'Sass' },
                            '.html': { icon: 'üåê', desc: 'HTML' },
                            '.py': { icon: 'üêç', desc: 'Python' },
                            '.sh': { icon: 'üíª', desc: 'Shell Script' },
                            '.yml': { icon: '‚öôÔ∏è', desc: 'YAML Config' },
                            '.yaml': { icon: '‚öôÔ∏è', desc: 'YAML Config' }
                        };

                        if (fileTypeMap[fileExt]) {
                            fileIcon = fileTypeMap[fileExt].icon;
                            fileTypeDesc = fileTypeMap[fileExt].desc;
                        }
                    } else {
                        fileTypeDesc = 'Deleted File';
                    }

                    // Add file to selected set by default
                    selectedFiles.add(file);

                    const fileDiv = document.createElement('div');
                    fileDiv.className = 'file-item';
                    fileDiv.innerHTML = `
                        <div class="file-header" onclick="toggleFile('${file}', '${fileId}')">
                            <div class="file-path">
                                <span class="expand-icon" id="icon-${fileId}">‚ñ∂Ô∏è</span>
                                <span>${fileIcon}</span>
                                <span>${file}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;" onclick="event.stopPropagation();">
                                    <input
                                        type="checkbox"
                                        id="select-${fileId}"
                                        data-filename="${file}"
                                        checked
                                        onchange="toggleFileSelection('${file}', '${fileId}')"
                                        title="Include in AI review export"
                                        style="accent-color: #2ea043;"
                                    >
                                    <span style="font-size: 12px; color: #7d8590;">Include</span>
                                </label>
                                <button
                                    class="comment-btn"
                                    onclick="event.stopPropagation(); showCommentModal('${file}', '${fileId}')"
                                    title="Add comment for this file"
                                >
                                    <span id="comment-indicator-${fileId}" style="display: none;">üí¨</span>
                                    üí≠
                                </button>
                                <div class="file-stats" id="stats-${fileId}">
                                    <span>Click to load diff</span>
                                </div>
                                <span class="badge ${badgeClass}">${badgeText}</span>
                            </div>
                        </div>
                        <div class="file-diff" id="diff-${fileId}">
                            <div style="padding: 20px; text-align: center; color: #7d8590;">
                                <div class="spinner" style="margin: 0 auto 12px;"></div>
                                Loading diff for ${fileName}...
                            </div>
                        </div>
                    `;
                    container.appendChild(fileDiv);
                });
            } catch (error) {
                document.getElementById('fileList').innerHTML = `
                    <div class="error-message">
                        Error loading files: ${error.message}
                    </div>
                `;
            }
        }

        async function toggleFile(file, fileId) {
            const diffDiv = document.getElementById(`diff-${fileId}`);
            const icon = document.getElementById(`icon-${fileId}`);

            if (diffDiv.classList.contains('active')) {
                diffDiv.classList.remove('active');
                icon.classList.remove('rotated');
                return;
            }

            // Close all other diffs
            document.querySelectorAll('.file-diff').forEach(d => d.classList.remove('active'));
            document.querySelectorAll('.expand-icon').forEach(i => i.classList.remove('rotated'));

            icon.classList.add('rotated');

            if (!allDiffs[file]) {
                try {
                    const response = await fetch(`/api/file-diff?file=${encodeURIComponent(file)}`);
                    const data = await response.json();
                    allDiffs[file] = data.diff;
                    allParsedDiffs[file] = data.parsedDiff;
                    renderDiff(diffDiv, data.diff, file, data.parsedDiff);
                    updateFileStats(fileId, data.diff);
                } catch (error) {
                    diffDiv.innerHTML = `<div class="error-message">Error loading diff: ${error.message}</div>`;
                }
            } else {
                renderDiff(diffDiv, allDiffs[file], file, allParsedDiffs[file]);
            }

            diffDiv.classList.add('active');
        }

        // Line commenting functions
        function addLineComment(lineId, filename, lineNumber) {
            currentLineId = lineId;
            currentCommentFile = filename;
            currentLineNumber = lineNumber;

            const modal = document.getElementById('commentModal');
            const fileNameSpan = document.getElementById('modalFileName');
            const textarea = document.getElementById('commentTextarea');

            fileNameSpan.textContent = `for ${filename} - Line ${lineNumber}`;
            textarea.value = lineComments[lineId] || '';
            textarea.placeholder = `Add comment for line ${lineNumber}...`;
            textarea.focus();

            modal.classList.add('active');
        }

        function saveComment() {
            const textarea = document.getElementById('commentTextarea');
            const comment = textarea.value.trim();

            if (currentLineId) {
                // Line-specific comment
                if (comment) {
                    lineComments[currentLineId] = comment;
                    console.log(`üí¨ Line comment added: ${currentCommentFile} Line ${currentLineNumber}: "${comment.substring(0, 50)}${comment.length > 50 ? '...' : ''}"`);

                    // Send to server for logging
                    fetch('/api/log-comment', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            type: 'line_comment',
                            file: currentCommentFile,
                            lineNumber: currentLineNumber,
                            comment: comment
                        })
                    });

                    showLineComment(currentLineId, comment);
                } else {
                    delete lineComments[currentLineId];
                    console.log(`‚ùå Line comment removed: ${currentCommentFile} Line ${currentLineNumber}`);
                    hideLineComment(currentLineId);
                }
                currentLineId = '';
            } else {
                // File-level comment (existing functionality)
                if (comment) {
                    fileComments[currentCommentFile] = comment;
                    console.log(`üí¨ File comment added: ${currentCommentFile}: "${comment.substring(0, 50)}${comment.length > 50 ? '...' : ''}"`);

                    const commentBtn = document.querySelector(`[onclick*="'${currentCommentFile}'"]`);
                    if (commentBtn) {
                        commentBtn.classList.add('has-comment');
                        const indicator = document.getElementById(`comment-indicator-${currentCommentFileId}`);
                        if (indicator) indicator.style.display = 'inline';
                    }
                    showCommentInFile(currentCommentFile, currentCommentFileId, comment);
                } else {
                    delete fileComments[currentCommentFile];
                    console.log(`‚ùå File comment removed: ${currentCommentFile}`);
                    const commentBtn = document.querySelector(`[onclick*="'${currentCommentFile}'"]`);
                    if (commentBtn) {
                        commentBtn.classList.remove('has-comment');
                        const indicator = document.getElementById(`comment-indicator-${currentCommentFileId}`);
                        if (indicator) indicator.style.display = 'none';
                    }
                    removeCommentFromFile(currentCommentFileId);
                }
            }

            closeCommentModal();
        }

        function showLineComment(lineId, comment) {
            const commentDiv = document.getElementById(`comment-${lineId}`);
            const lineContainer = document.querySelector(`[data-line-id="${lineId}"]`);

            if (commentDiv && lineContainer) {
                const actualLineNum = lineContainer.getAttribute('data-new-line') || lineContainer.getAttribute('data-old-line');
                commentDiv.innerHTML = `üí≠ <strong>Line ${actualLineNum}:</strong> ${escapeHtml(comment)}`;
                commentDiv.classList.add('line-comment-visible');
                commentDiv.style.display = 'block';
                lineContainer.classList.add('has-line-comment');

                console.log(`‚úÖ Line comment displayed: Line ${actualLineNum} in ${currentCommentFile}`);
            }
        }

        function hideLineComment(lineId) {
            const commentDiv = document.getElementById(`comment-${lineId}`);
            const lineContainer = document.querySelector(`[data-line-id="${lineId}"]`);

            if (commentDiv) commentDiv.style.display = 'none';
            if (lineContainer) lineContainer.classList.remove('has-line-comment');
        }

        function renderDiff(container, diff, filename, parsedDiff) {
            if (!diff.trim() || !parsedDiff?.chunks?.length) {
                container.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #7d8590;">
                        <span style="font-size: 32px;">üìÑ</span>
                        <p>No changes detected in ${filename}</p>
                    </div>
                `;
                return;
            }

            let html = '';

            parsedDiff.chunks.forEach((chunk, chunkIndex) => {
                // Render chunk header
                html += `<div class="diff-header">${escapeHtml(chunk.header)}</div>`;

                chunk.lines.forEach((line, lineIndex) => {
                    const lineId = `${filename.replace(/[^a-zA-Z0-9]/g, '_')}_${chunkIndex}_${lineIndex}`;
                    const oldNum = line.oldLineNum;
                    const newNum = line.newLineNum;

                    let className = 'diff-context';
                    if (line.type === 'added') {
                        className = 'diff-added';
                    } else if (line.type === 'removed') {
                        className = 'diff-removed';
                    }

                    html += `
                        <div class="diff-line-container ${className}" data-line-id="${lineId}" data-file="${filename}" data-old-line="${oldNum}" data-new-line="${newNum}">
                            <div class="line-numbers">
                                <span class="old-line-num">${oldNum || ''}</span>
                                <span class="new-line-num">${newNum || ''}</span>
                                <button class="add-comment-btn" onclick="addLineComment('${lineId}', '${filename}', ${oldNum || newNum})" title="Add comment to this line">üí¨</button>
                            </div>
                            <div class="line-content">
                                <code>${escapeHtml(line.content)}</code>
                            </div>
                            <div class="line-comment" id="comment-${lineId}" style="display: none;"></div>
                        </div>
                    `;
                });
            });

            container.innerHTML = html;
        }

        function updateFileStats(fileId, diff) {
            const lines = diff.split('\n');
            const added = lines.filter(line => line.startsWith('+') && !line.startsWith('+++')).length;
            const removed = lines.filter(line => line.startsWith('-') && !line.startsWith('---')).length;

            const statsElement = document.getElementById(`stats-${fileId}`);
            statsElement.innerHTML = `
                <span style="color: #aff5b4;">+${added}</span>
                <span style="color: #ffdcd7;">-${removed}</span>
            `;
        }

        // Toggle file selection for export
        function toggleFileSelection(file, fileId) {
            const checkbox = document.getElementById(`select-${fileId}`);
            const fileItem = checkbox.closest('.file-item');

            if (checkbox.checked) {
                selectedFiles.add(file);
                fileItem.style.opacity = '1';
                console.log(`‚úÖ File included in export: ${file}`);
            } else {
                selectedFiles.delete(file);
                fileItem.style.opacity = '0.6';
                console.log(`‚è≠Ô∏è  File excluded from export: ${file}`);
            }

            updateExportButtonText();
        }

        // Update export button text with selection count
        function updateExportButtonText() {
            const btn = document.getElementById('exportBtn');
            const total = document.querySelectorAll('input[type="checkbox"][id^="select-"]').length;
            const selected = selectedFiles.size;

            if (selected === total) {
                btn.innerHTML = '<span>üì§</span> Export for AI Review';
            } else {
                btn.innerHTML = `<span>üì§</span> Export ${selected}/${total} Files for AI Review`;
            }
        }

        async function exportForAI() {
            const btn = document.getElementById('exportBtn');
            const originalText = btn.innerHTML;

            // Get excluded files - simplified approach using data attributes
            const allCheckboxes = Array.from(document.querySelectorAll('input[type="checkbox"][id^="select-"]'));
            const allFiles = allCheckboxes.map(cb => cb.getAttribute('data-filename')).filter(f => f);
            const excludedFiles = allFiles.filter(file => !selectedFiles.has(file));

            console.log(`üìã Export Summary:`);
            console.log(`   Selected files: ${selectedFiles.size}`);
            console.log(`   Excluded files: ${excludedFiles.length}`);

            if (excludedFiles.length > 0) {
                console.log(`‚è≠Ô∏è  Files excluded from AI review:`, excludedFiles);
            }

            btn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px;"></div> Generating...';
            btn.disabled = true;

            try {
                // Send comments and exclusions with export request
                const response = await fetch('/api/export-for-ai', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        comments: fileComments,
                        lineComments: lineComments,
                        excludedFiles: excludedFiles
                    })
                });
                const data = await response.json();

                if (data.success) {
                    btn.innerHTML = '‚úÖ Generated AI_REVIEW.md';

                    // Show success message
                    const container = document.querySelector('.container');
                    const successDiv = document.createElement('div');
                    successDiv.className = 'success-message';
                    successDiv.innerHTML = `
                        <strong>‚úÖ AI Review Generated!</strong><br>
                        üìÑ Created: ${data.file}<br>
                        üìä Files processed: ${data.filesProcessed} (${excludedFiles.length} excluded)<br>
                        üí¨ Comments included: ${Object.keys(fileComments).length}<br>
                        üîç Line comments: ${Object.keys(lineComments).length}<br>
                        üí° Next: Ask Cline or ChatGPT to review the generated file
                    `;
                    container.insertBefore(successDiv, container.firstChild);

                    // Remove success message after 5 seconds
                    setTimeout(() => {
                        successDiv.remove();
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }, 5000);
                } else {
                    throw new Error(data.error || 'Export failed');
                }
            } catch (error) {
                btn.innerHTML = '‚ùå Export Failed';

                const container = document.querySelector('.container');
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.innerHTML = `<strong>‚ùå Export Failed:</strong> ${error.message}`;
                container.insertBefore(errorDiv, container.firstChild);

                setTimeout(() => {
                    errorDiv.remove();
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 5000);
            }
        }

        async function exportIndividualReviews() {
            const btn = document.getElementById('exportIndividualBtn');
            const originalText = btn.innerHTML;

            // Get excluded files - same logic as exportForAI
            const allCheckboxes = Array.from(document.querySelectorAll('input[type="checkbox"][id^="select-"]'));
            const allFiles = allCheckboxes.map(cb => cb.getAttribute('data-filename')).filter(f => f);
            const excludedFiles = allFiles.filter(file => !selectedFiles.has(file));

            console.log(`üìÅ Individual Export Summary:`);
            console.log(`   Selected files: ${selectedFiles.size}`);
            console.log(`   Excluded files: ${excludedFiles.length}`);

            if (excludedFiles.length > 0) {
                console.log(`‚è≠Ô∏è  Files excluded from individual review:`, excludedFiles);
            }

            btn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px;"></div> Creating...';
            btn.disabled = true;

            try {
                // Send comments and exclusions with export request
                const response = await fetch('/api/export-individual-reviews', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        comments: fileComments,
                        lineComments: lineComments,
                        excludedFiles: excludedFiles
                    })
                });
                const data = await response.json();

                if (data.success) {
                    btn.innerHTML = '‚úÖ Created Review Directory';

                    // Show success message
                    const container = document.querySelector('.container');
                    const successDiv = document.createElement('div');
                    successDiv.className = 'success-message';
                    successDiv.innerHTML = `
                        <strong>‚úÖ Individual Review Files Created!</strong><br>
                        üìÅ Directory: ${data.directory}<br>
                        üìÑ Files created: ${data.filesCreated} review files<br>
                        üìä Total changes: ${data.totalFiles} files (${data.excludedCount} excluded)<br>
                        üí¨ Comments included: ${data.commentsIncluded || 0}<br>
                        üí° Next: Open the directory to review files individually
                    `;
                    container.insertBefore(successDiv, container.firstChild);

                    // Remove success message after 5 seconds
                    setTimeout(() => {
                        successDiv.remove();
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }, 5000);
                } else {
                    throw new Error(data.error || 'Export failed');
                }
            } catch (error) {
                btn.innerHTML = '‚ùå Export Failed';

                const container = document.querySelector('.container');
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.innerHTML = `<strong>‚ùå Individual Export Failed:</strong> ${error.message}`;
                container.insertBefore(errorDiv, container.firstChild);

                setTimeout(() => {
                    errorDiv.remove();
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 5000);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('commentModal').classList.contains('active')) {
                closeCommentModal();
            }
            if (e.ctrlKey && e.key === 'Enter' && document.getElementById('commentModal').classList.contains('active')) {
                saveComment();
            }
        });

        // Auto-refresh every 30 seconds
        setInterval(async () => {
            await loadHealthCheck();
        }, 30000);

        // Simplified GitStatusParser logic for frontend
        function parseGitStatus(statusCode) {
            const status = statusCode || 'M';

            // Handle comprehensive git status combinations
            if (status.includes('D')) {
                return { badgeClass: 'deleted', badgeText: getStatusLabel(status), icon: 'üóëÔ∏è' };
            } else if (status.includes('U')) {
                return { badgeClass: 'modified', badgeText: 'Conflict', icon: '‚ö†Ô∏è' };
            } else if (status[0] === 'A' || status[0] === 'C') {
                return { badgeClass: 'added', badgeText: getStatusLabel(status), icon: '‚ú®' };
            } else if (status.includes('R')) {
                return { badgeClass: 'modified', badgeText: getStatusLabel(status), icon: 'üîÑ' };
            } else {
                return { badgeClass: 'modified', badgeText: getStatusLabel(status), icon: 'üìù' };
            }
        }

        function getStatusLabel(statusCode) {
            const statusMap = {
                'M': 'Modified',
                'A': 'Added',
                'D': 'Deleted',
                'R': 'Renamed',
                'C': 'Copied',
                'U': 'Conflict',
                'AD': 'Added‚ÜíDeleted',
                'AM': 'Added‚ÜíModified',
                'MD': 'Modified‚ÜíDeleted',
                'RM': 'Renamed‚ÜíModified',
                'RD': 'Renamed‚ÜíDeleted',
                'UD': 'Conflict‚ÜíDeleted',
                'AU': 'Added‚ÜíConflict'
            };

            return statusMap[statusCode] || 'Modified';
        }

        // Initialize when page loads
        init();
    </script>
</body>
</html>
