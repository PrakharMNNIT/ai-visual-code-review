# 🎯 Unified Export System - Complete Guide

## 🔍 Overview

The AI Visual Code Review package now uses a **unified export script** that ensures **consistent AI_REVIEW.md formatting** regardless of how you generate it:

- ✅ CLI `ai-review quick`
- ✅ Web Interface `ai-review start` → Export button
- ✅ Direct script call
- ✅ Package.json scripts

**All methods now produce identical output with proper line numbers and +/- diff formatting!**

---

## 🆕 What Changed

### Before (v1.0.4)

- ❌ CLI used bash script → Basic diff format
- ❌ Web interface used Node.js → Enhanced format with line numbers
- ❌ Inconsistent output between methods
- ❌ Arguments not passed to bash script

### After (v2.0)

- ✅ **Single unified Node.js script** (`scripts/export-ai-review.js`)
- ✅ **DiffService** formats all diffs consistently
- ✅ **Line numbers with +/- signs** in all exports
- ✅ **Arguments work** (`--include`, `--exclude`, etc.)

---

## 📦 The Unified Export Script

**Location:** `scripts/export-ai-review.js`

This script:

1. Uses `DiffService.generateEnhancedDiffMarkdown()` for consistent formatting
2. Supports all include/exclude patterns
3. Handles file size limits
4. Works from CLI, web interface, or direct call

---

## 🚀 Usage Guide

### Method 1: CLI Quick Export

```bash
# Basic export (all staged files)
ai-review quick

# With include patterns
ai-review quick --include "src/**/*.ts"
ai-review quick --include "packages/core/src/**/*.ts"

# With exclude patterns
ai-review quick --exclude "*.log" "dist/*" "node_modules/*"

# No size limit
ai-review quick --no-size-limit

# Custom size limit
ai-review quick --max-size 5000
```

### Method 2: Web Interface Export

```bash
# Start server
ai-review start

# Or with auto-open
ai-review start --open

# Then:
# 1. Open http://localhost:3002
# 2. Review changes
# 3. Select/deselect files
# 4. Click "Export for AI Review"
# Result: AI_REVIEW.md with same format as CLI!
```

### Method 3: Direct Script Call

```bash
# Call the unified script directly
node scripts/export-ai-review.js

# With options
node scripts/export-ai-review.js --include "src/**/*.ts"
node scripts/export-ai-review.js --exclude "*.log"
```

### Method 4: Package.json Scripts

```json
{
  "scripts": {
    "review": "ai-review start",
    "review:quick": "ai-review quick",
    "review:core": "ai-review quick --include 'packages/core/src/**/*.ts'",
    "review:cli": "ai-review quick --include 'packages/cli/src/**/*.ts'",
    "review:docs": "ai-review quick --include 'docs/**/*.md'",
    "review:tests": "ai-review quick --include '**/*.test.ts' '**/*.spec.ts'"
  }
}
```

Then run:

```bash
npm run review:core
npm run review:cli
npm run review:docs
```

---

## 📊 Output Format

All methods produce **identical output** with this format:

```markdown
# 🔍 Code Review - [timestamp]

**Project:** AI Visual Code Review
**Generated by:** AI Visual Code Review v2.0

## 📊 Change Summary

\`\`\`
 file1.ts | 10 +++++-----
 file2.ts | 5 +++--
 2 files changed, 8 insertions(+), 7 deletions(-)
\`\`\`

## 📝 Files Changed (2/2 selected)

### 📄 `src/file1.ts`

**Type:** TypeScript Source File 📘

\`\`\`diff
@@ -10,7 +10,7 @@ function example() {
 10  10   const value = 'unchanged line';
 11  11   const another = 'also unchanged';
 12      - const old = 'this was removed';
     13  + const new = 'this was added';
 13  14   return value;
\`\`\`
```

### Key Features of Output

1. **Line Numbers**: Both old and new line numbers shown
2. **Diff Markers**: `+` for additions, `-` for deletions
3. **Context Lines**: Unchanged lines shown with both numbers
4. **File Type Detection**: Automatic file type identification
5. **Review Checklists**: Comprehensive AI review checklist included

---

## 🔧 Configuration Options

### Include Patterns

Use `--include` to ONLY process specific files:

```bash
# Single pattern
ai-review quick --include "src/**/*.ts"

# Multiple patterns
ai-review quick --include "src/**/*.ts" "src/**/*.tsx" "*.json"

# Specific files
ai-review quick --include "package.json" "README.md"
```

### Exclude Patterns

Use `--exclude` to skip specific files:

```bash
# Exclude lock files
ai-review quick --exclude "package-lock.json" "yarn.lock"

# Exclude directories
ai-review quick --exclude "dist/*" "node_modules/*" "coverage/*"

# Exclude file types
ai-review quick --exclude "*.log" "*.map"
```

### File Size Management

```bash
# Default: Skip files over 10,000 lines
ai-review quick

# Custom size limit
ai-review quick --max-size 5000

# No size limit (include all files)
ai-review quick --no-size-limit
```

---

## 🎨 Pattern Matching Examples

The unified script supports various pattern types:

| Pattern | Matches | Example |
|---------|---------|---------|
| `*.ts` | All .ts files | `app.ts`, `utils.ts` |
| `src/*.ts` | .ts files in src/ | `src/app.ts` (not subdirs) |
| `src/**/*.ts` | .ts files in src/ and subdirs | `src/utils/helper.ts` |
| `**/*.test.ts` | All test files | `src/app.test.ts` |
| `packages/*/src/**/*.ts` | All .ts in package src/ | `packages/cli/src/index.ts` |

---

## 💡 Common Use Cases

### 1. Review Specific Package in Monorepo

```bash
ai-review quick --include "packages/core/**/*"
```

### 2. Review Only Tests

```bash
ai-review quick --include "**/*.test.ts" "**/*.spec.ts"
```

### 3. Review Documentation Only

```bash
ai-review quick --include "**/*.md" "docs/**/*"
```

### 4. Review Configuration Files

```bash
ai-review quick --include "*.json" "*.yaml" "*.toml" ".env.example"
```

### 5. Exclude Generated Files

```bash
ai-review quick --exclude "dist/*" "build/*" "coverage/*" "*.min.js"
```

### 6. Large Codebase Review

```bash
# Break into sections
ai-review quick --include "src/components/**/*"
ai-review quick --include "src/services/**/*"
ai-review quick --include "src/utils/**/*"
```

---

## 🔍 How It Works

### 1. CLI Flow

```
User runs: ai-review quick --include "src/**/*.ts"
         ↓
bin/ai-review.js parses arguments
         ↓
Calls: scripts/export-ai-review.js with arguments
         ↓
Script uses DiffService.generateEnhancedDiffMarkdown()
         ↓
Generates AI_REVIEW.md with line numbers
```

### 2. Web Interface Flow

```
User clicks "Export for AI Review"
         ↓
POST /api/export-for-ai
         ↓
server.js uses DiffService.generateEnhancedDiffMarkdown()
         ↓
Generates AI_REVIEW.md with line numbers
```

### 3. DiffService Processing

```javascript
// Both CLI and Web use this:
const diff = execSync(`git diff --cached -- "${file}"`);
const formatted = DiffService.generateEnhancedDiffMarkdown(diff);

// DiffService internally:
// 1. Parses git diff output
// 2. Extracts line numbers
// 3. Formats with proper +/- indicators
// 4. Returns markdown-ready output
```

---

## 📋 Troubleshooting

### Issue: Arguments Not Working

**Symptom:** `ai-review quick --include "src/**/*.ts"` includes all files

**Solution:** Ensure you're using v2.0+ with the updated CLI:

```bash
# Check version
ai-review --version

# Re-install if needed
npm install -g ai-visual-code-review@latest
```

### Issue: No Line Numbers in Output

**Symptom:** AI_REVIEW.md shows raw diff without line numbers

**Solution:** The unified script should fix this. If not:

```bash
# Call unified script directly
node node_modules/ai-visual-code-review/scripts/export-ai-review.js
```

### Issue: Pattern Not Matching

**Symptom:** `--include` pattern doesn't match expected files

**Solutions:**

```bash
# Use quotes for patterns with wildcards
ai-review quick --include "src/**/*.ts"  # ✅ Correct
ai-review quick --include src/**/*.ts    # ❌ Shell may expand

# Test pattern matching
git diff --cached --name-only  # See all staged files
```

---

## 🎯 Best Practices

### 1. Always Stage Changes First

```bash
git add .
ai-review quick
```

### 2. Use Specific Patterns for Large Repos

```bash
# Instead of reviewing everything
ai-review quick

# Review by section
ai-review quick --include "packages/core/**/*"
```

### 3. Exclude Generated Files by Default

```bash
# Good default for most projects
ai-review quick --exclude "dist/*" "build/*" "*.min.js" "coverage/*"
```

### 4. Create Project-Specific Scripts

```json
{
  "scripts": {
    "review:api": "ai-review quick --include 'src/api/**/*'",
    "review:frontend": "ai-review quick --include 'src/components/**/*' 'src/pages/**/*'",
    "review:config": "ai-review quick --include '*.json' '*.yaml'"
  }
}
```

---

## 📚 Related Documentation

- **NPM_SCRIPTS_ANALYSIS.md** - Detailed analysis of script issues and solutions
- **README.md** - Main project documentation
- **SETUP.md** - Installation and setup guide

---

## 🎉 Summary

The unified export system ensures:

✅ **Consistent formatting** across all export methods
✅ **Proper line numbers** with +/- diff markers
✅ **Working arguments** for include/exclude patterns
✅ **Same AI_REVIEW.md** whether using CLI or web interface
✅ **Better AI analysis** with enhanced diff context

Now you can confidently use any method to generate AI reviews, knowing the output will be identical and optimized for AI code review tools like ChatGPT and Claude!
